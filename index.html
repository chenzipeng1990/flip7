<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="touch-action" content="none"> <!-- 彻底禁用移动端触摸行为 -->
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>7连翻游戏记分版</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            touch-action: none;
        }
        body {
            font-family: Arial, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
            background-color: #f5f5f5;
            min-height: 100vh;
            touch-action: none;
        }
        .main-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            width: 100%;
            max-width: 600px;
        }
        .score-container {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 40px;
            justify-content: center;
            width: 100%;
        }
        .score-block {
            width: 80px;
            height: 80px;
            background-color: #2c3e50;
            color: white;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            font-size: 14px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            user-select: none;
            position: relative;
            z-index: 1;
            padding: 5px;
            text-align: center;
        }
        .score-block .nickname {
            font-size: 12px;
            margin-bottom: 3px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            width: 100%;
        }
        .score-block .score {
            font-size: 20px;
        }
        .score-block.pressed {
            background-color: #34495e;
            transform: scale(0.98);
        }
        .score-block.long-press {
            background-color: #e74c3c;
        }
        .add-btn {
            width: 80px;
            height: 80px;
            background-color: #ecf0f1;
            border: 2px dashed #bdc3c7;
            color: #7f8c8d;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 36px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            user-select: none;
            z-index: 1;
        }
        .add-btn.pressed {
            background-color: #e0e6e8;
            transform: scale(0.98);
        }
        .clear-btn {
            padding: 12px 40px;
            background-color: #2c3e50;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 18px;
            cursor: pointer;
            transition: all 0.2s ease;
            user-select: none;
            z-index: 1;
        }
        .clear-btn.pressed {
            background-color: #34495e;
            transform: scale(0.98);
        }
        /* 自定义弹窗样式 */
        .custom-prompt {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            touch-action: none;
        }
        .prompt-dialog {
            background: white;
            padding: 25px;
            border-radius: 10px;
            width: 85%;
            max-width: 320px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
        }
        .prompt-title {
            font-size: 17px;
            color: #333;
            margin-bottom: 20px;
            text-align: center;
        }
        .prompt-input {
            width: 100%;
            padding: 12px;
            font-size: 18px;
            border: 1px solid #ddd;
            border-radius: 6px;
            margin-bottom: 20px;
            text-align: center;
            outline: none;
            -webkit-appearance: none;
        }
        .prompt-btns {
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
        }
        .prompt-btn {
            padding: 10px 25px;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.2s ease;
            flex: 1;
            min-width: 100px;
        }
        .btn-cancel {
            background-color: #ecf0f1;
            color: #7f8c8d;
        }
        .btn-cancel:active {
            background-color: #d5dbdb;
        }
        .btn-confirm {
            background-color: #2c3e50;
            color: white;
        }
        .btn-confirm:active {
            background-color: #34495e;
        }
        .btn-edit-nickname {
            background-color: #3498db;
            color: white;
        }
        .btn-edit-nickname:active {
            background-color: #2980b9;
        }
        .btn-delete-block {
            background-color: #e74c3c;
            color: white;
        }
        .btn-delete-block:active {
            background-color: #c0392b;
        }
    </style>
</head>
<body>
    <div class="main-container">
        <div class="score-container">
            <!-- 这里的计分块会由本地存储数据渲染，默认先留空 -->
            <div class="add-btn">+</div>
        </div>
        <button class="clear-btn">清空</button>
    </div>

    <script>
        // 全局变量
        const scoreContainer = document.querySelector('.score-container');
        const addBtn = document.querySelector('.add-btn');
        const clearBtn = document.querySelector('.clear-btn');
        const LONG_PRESS_TIME = 800;
        const STORAGE_KEY = 'sevenFlipScoreData'; // 本地存储的键名
        let pressTimer = null;
        let activeBlock = null; // 当前按压的块
        let isLongPressTriggered = false;

        // ========== 本地存储核心函数 ==========
        /**
         * 保存当前所有计分块数据到localStorage
         */
        function saveScoreDataToLocal() {
            const scoreBlocks = document.querySelectorAll('.score-block');
            // 收集所有计分块的昵称和分数
            const scoreData = Array.from(scoreBlocks).map(block => ({
                nickname: block.dataset.nickname || '',
                score: parseInt(block.dataset.score || 0)
            }));
            // 转换为JSON字符串存储
            localStorage.setItem(STORAGE_KEY, JSON.stringify(scoreData));
        }

        /**
         * 从localStorage加载计分块数据
         * @returns {Array} 计分块数据数组，格式：[{nickname: 'xxx', score: 0}, ...]
         */
        function loadScoreDataFromLocal() {
            const savedData = localStorage.getItem(STORAGE_KEY);
            if (!savedData) {
                // 没有保存的数据，返回默认的两个玩家数据
                return [
                    { nickname: '玩家1', score: 0 },
                    { nickname: '玩家2', score: 0 }
                ];
            }
            try {
                const parsedData = JSON.parse(savedData);
                // 确保数据是数组，且至少有2个计分块（防止数据损坏）
                if (Array.isArray(parsedData) && parsedData.length >= 2) {
                    return parsedData;
                } else {
                    return [
                        { nickname: '玩家1', score: 0 },
                        { nickname: '玩家2', score: 0 }
                    ];
                }
            } catch (e) {
                console.error('加载本地存储数据失败，使用默认数据：', e);
                return [
                    { nickname: '玩家1', score: 0 },
                    { nickname: '玩家2', score: 0 }
                ];
            }
        }

        /**
         * 根据加载的数据渲染计分块
         */
        function renderScoreBlocksFromData() {
            const scoreData = loadScoreDataFromLocal();
            // 先清空已有的计分块（保留+按钮）
            document.querySelectorAll('.score-block').forEach(block => block.remove());
            // 遍历数据创建计分块
            scoreData.forEach(data => {
                createScoreBlock(data.nickname, data.score);
            });
        }

        /**
         * 创建单个计分块并添加到页面（复用逻辑）
         * @param {string} nickname 玩家昵称
         * @param {number} score 初始分数
         */
        function createScoreBlock(nickname, score) {
            const newBlock = document.createElement('div');
            newBlock.className = 'score-block';
            newBlock.dataset.nickname = nickname;
            newBlock.dataset.score = score;
            newBlock.innerHTML = `
                <div class="nickname">${nickname}</div>
                <div class="score">${score}</div>
            `;
            // 绑定触摸事件
            newBlock.addEventListener('touchstart', handleTouchStart);
            newBlock.addEventListener('touchend', handleTouchEnd);
            newBlock.addEventListener('touchcancel', handleTouchEnd);
            // 绑定PC端事件
            newBlock.addEventListener('click', () => {
                if (!isLongPressTriggered) {
                    handleScoreEdit(newBlock);
                }
            });
            newBlock.addEventListener('mousedown', (e) => {
                e.preventDefault();
                newBlock.classList.add('pressed');
                pressTimer = setTimeout(() => {
                    isLongPressTriggered = true;
                    handleLongPress(newBlock);
                }, LONG_PRESS_TIME);
            });
            newBlock.addEventListener('mouseup', () => {
                clearTimeout(pressTimer);
                newBlock.classList.remove('pressed');
            });
            newBlock.addEventListener('mouseleave', () => {
                clearTimeout(pressTimer);
                newBlock.classList.remove('pressed');
            });
            // 插入到+按钮前面
            scoreContainer.insertBefore(newBlock, addBtn);
        }

        // ========== 昵称输入弹窗（新增/修改通用） ==========
        function showNicknamePrompt(title = '请输入玩家昵称', defaultNickname = '') {
            return new Promise((resolve) => {
                const promptEl = document.createElement('div');
                promptEl.className = 'custom-prompt';
                promptEl.innerHTML = `
                    <div class="prompt-dialog">
                        <div class="prompt-title">${title}</div>
                        <input type="text" class="prompt-input" placeholder="例如：张三" autocomplete="off" value="${defaultNickname}">
                        <div class="prompt-btns">
                            <button class="prompt-btn btn-cancel">取消</button>
                            <button class="prompt-btn btn-confirm">确认</button>
                        </div>
                    </div>
                `;
                document.body.appendChild(promptEl);

                const input = promptEl.querySelector('.prompt-input');
                const cancelBtn = promptEl.querySelector('.btn-cancel');
                const confirmBtn = promptEl.querySelector('.btn-confirm');

                // 强制聚焦输入框并选中现有内容（修改时）
                setTimeout(() => {
                    input.focus();
                    if (defaultNickname) {
                        input.setSelectionRange(0, defaultNickname.length);
                    }
                }, 100);

                // 取消按钮
                cancelBtn.addEventListener('click', () => {
                    document.body.removeChild(promptEl);
                    resolve(null);
                });

                // 确认按钮
                confirmBtn.addEventListener('click', () => {
                    const value = input.value.trim();
                    document.body.removeChild(promptEl);
                    resolve(value);
                });

                // 点击外部关闭
                promptEl.addEventListener('click', (e) => {
                    if (e.target === promptEl) {
                        document.body.removeChild(promptEl);
                        resolve(null);
                    }
                });

                // 回车确认
                input.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') {
                        const value = input.value.trim();
                        document.body.removeChild(promptEl);
                        resolve(value);
                    }
                });
            });
        }

        // ========== 长按操作选项弹窗 ==========
        function showLongPressOptionsPrompt(block) {
            return new Promise((resolve) => {
                const promptEl = document.createElement('div');
                promptEl.className = 'custom-prompt';
                promptEl.innerHTML = `
                    <div class="prompt-dialog">
                        <div class="prompt-title">请选择操作（${block.dataset.nickname}）</div>
                        <div class="prompt-btns">
                            <button class="prompt-btn btn-edit-nickname">修改昵称</button>
                            <button class="prompt-btn btn-delete-block">删除计分块</button>
                            <button class="prompt-btn btn-cancel">取消</button>
                        </div>
                    </div>
                `;
                document.body.appendChild(promptEl);

                const editNicknameBtn = promptEl.querySelector('.btn-edit-nickname');
                const deleteBlockBtn = promptEl.querySelector('.btn-delete-block');
                const cancelBtn = promptEl.querySelector('.btn-cancel');

                // 修改昵称按钮
                editNicknameBtn.addEventListener('click', () => {
                    document.body.removeChild(promptEl);
                    resolve('edit');
                });

                // 删除计分块按钮
                deleteBlockBtn.addEventListener('click', () => {
                    document.body.removeChild(promptEl);
                    resolve('delete');
                });

                // 取消按钮
                cancelBtn.addEventListener('click', () => {
                    document.body.removeChild(promptEl);
                    resolve(null);
                });

                // 点击外部关闭
                promptEl.addEventListener('click', (e) => {
                    if (e.target === promptEl) {
                        document.body.removeChild(promptEl);
                        resolve(null);
                    }
                });
            });
        }

        // ========== 触摸事件处理 ==========
        function handleTouchStart(e) {
            e.stopPropagation();
            e.preventDefault();
            
            const target = e.target.closest('.score-block');
            if (!target) return;

            activeBlock = target;
            isLongPressTriggered = false;

            target.classList.add('pressed');

            // 启动长按计时器
            pressTimer = setTimeout(() => {
                isLongPressTriggered = true;
                target.classList.add('long-press');
                handleLongPress(target);
            }, LONG_PRESS_TIME);
        }

        function handleTouchEnd(e) {
            e.stopPropagation();
            e.preventDefault();

            if (!activeBlock) return;

            // 清除计时器和样式
            clearTimeout(pressTimer);
            activeBlock.classList.remove('pressed', 'long-press');

            // 如果不是长按，触发分数编辑
            if (!isLongPressTriggered && activeBlock) {
                handleScoreEdit(activeBlock);
            }

            activeBlock = null;
        }

        // ========== 长按操作处理（核心修改） ==========
        async function handleLongPress(block) {
            // 弹出操作选项弹窗
            const action = await showLongPressOptionsPrompt(block);

            if (action === 'edit') {
                // 执行修改昵称逻辑
                handleEditNickname(block);
            } else if (action === 'delete') {
                // 执行删除计分块逻辑
                handleDeleteBlock(block);
            }
            // 取消则不执行任何操作
        }

        // ========== 修改昵称逻辑 ==========
        async function handleEditNickname(block) {
            // 获取当前昵称作为默认值
            const currentNickname = block.dataset.nickname;
            const newNickname = await showNicknamePrompt('请修改玩家昵称', currentNickname);

            if (!newNickname) {
                return; // 取消输入则返回
            }

            // 更新计分块的昵称
            block.dataset.nickname = newNickname;
            block.querySelector('.nickname').textContent = newNickname;
            // 保存数据到本地存储
            saveScoreDataToLocal();
        }

        // ========== 删除计分块逻辑 ==========
        function handleDeleteBlock(block) {
            const blockCount = document.querySelectorAll('.score-block').length;
            if (blockCount <= 2) {
                alert('至少保留2个计分块');
                return;
            }
            if (confirm(`确定删除 ${block.dataset.nickname} 的计分块吗？`)) {
                block.remove();
                // 删除后保存数据
                saveScoreDataToLocal();
            }
        }

        // ========== 分数编辑弹窗 ==========
        function showCustomPrompt() {
            return new Promise((resolve) => {
                const promptEl = document.createElement('div');
                promptEl.className = 'custom-prompt';
                promptEl.innerHTML = `
                    <div class="prompt-dialog">
                        <div class="prompt-title">请输入要添加的分数（增量）</div>
                        <input type="number" class="prompt-input" value="" autocomplete="off">
                        <div class="prompt-btns">
                            <button class="prompt-btn btn-cancel">取消</button>
                            <button class="prompt-btn btn-confirm">确认</button>
                        </div>
                    </div>
                `;
                document.body.appendChild(promptEl);

                const input = promptEl.querySelector('.prompt-input');
                const cancelBtn = promptEl.querySelector('.btn-cancel');
                const confirmBtn = promptEl.querySelector('.btn-confirm');

                // 强制聚焦输入框
                setTimeout(() => {
                    input.focus();
                    if (input.setSelectionRange) {
                        input.setSelectionRange(0, input.value.length);
                    }
                }, 100);

                // 取消按钮
                cancelBtn.addEventListener('click', () => {
                    document.body.removeChild(promptEl);
                    resolve(null);
                });

                // 确认按钮
                confirmBtn.addEventListener('click', () => {
                    const value = input.value.trim();
                    document.body.removeChild(promptEl);
                    resolve(value);
                });

                // 点击外部关闭
                promptEl.addEventListener('click', (e) => {
                    if (e.target === promptEl) {
                        document.body.removeChild(promptEl);
                        resolve(null);
                    }
                });

                // 回车确认
                input.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') {
                        const value = input.value.trim();
                        document.body.removeChild(promptEl);
                        resolve(value);
                    }
                });
            });
        }

        // ========== 分数编辑逻辑 ==========
        async function handleScoreEdit(block) {
            try {
                const currentScore = parseInt(block.dataset.score || 0);
                const addScoreStr = await showCustomPrompt();

                if (addScoreStr === null || addScoreStr === '') return;

                const addScore = parseInt(addScoreStr);
                if (isNaN(addScore)) {
                    alert('请输入有效的数字！');
                    return;
                }

                const newScore = currentScore + addScore;
                block.dataset.score = newScore;
                block.querySelector('.score').textContent = newScore;
                // 修改分数后保存数据
                saveScoreDataToLocal();
            } catch (e) {
                console.error('编辑分数出错：', e);
            }
        }

        // ========== 添加计分块逻辑 ==========
        async function handleAddBlock() {
            const currentBlocks = document.querySelectorAll('.score-block').length;
            if (currentBlocks >= 10) {
                alert('最多支持10人计分');
                return;
            }
            
            const nickname = await showNicknamePrompt();
            if (!nickname) {
                return;
            }
            
            // 创建新计分块，初始分数为0
            createScoreBlock(nickname, 0);
            // 添加后保存数据
            saveScoreDataToLocal();
        }

        // ========== 清空分数逻辑 ==========
        function handleClearScores() {
            document.querySelectorAll('.score-block').forEach(block => {
                block.dataset.score = '0';
                block.querySelector('.score').textContent = '0';
            });
            // 清空后保存数据
            saveScoreDataToLocal();
        }

        // ========== 初始化事件绑定 ==========
        function initEvents() {
            // 计分块事件已经在创建时绑定，这里处理按钮事件
            // +号按钮触摸事件
            addBtn.addEventListener('touchstart', (e) => {
                e.preventDefault();
                addBtn.classList.add('pressed');
            });
            addBtn.addEventListener('touchend', (e) => {
                e.preventDefault();
                addBtn.classList.remove('pressed');
                handleAddBlock();
            });

            // 清空按钮触摸事件
            clearBtn.addEventListener('touchstart', (e) => {
                e.preventDefault();
                clearBtn.classList.add('pressed');
            });
            clearBtn.addEventListener('touchend', (e) => {
                e.preventDefault();
                clearBtn.classList.remove('pressed');
                handleClearScores();
            });

            // PC端按钮点击事件
            addBtn.addEventListener('click', handleAddBlock);
            clearBtn.addEventListener('click', handleClearScores);
        }

        // ========== 页面初始化 ==========
        window.addEventListener('DOMContentLoaded', () => {
            // 1. 先从本地存储加载并渲染计分块
            renderScoreBlocksFromData();
            // 2. 绑定所有事件
            initEvents();
            // 3. 禁用浏览器默认触摸滚动行为
            document.addEventListener('touchmove', (e) => e.preventDefault(), { passive: false });
        });
    </script>
</body>
</html>