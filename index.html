<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="touch-action" content="none"> <!-- 彻底禁用移动端触摸行为 -->
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>7连翻游戏记分版</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            touch-action: none;
        }
        body {
            font-family: Arial, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
            background-color: #f5f5f5;
            min-height: 100vh;
            touch-action: none;
        }
        .main-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            width: 100%;
            max-width: 600px;
        }
        .score-container {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 40px;
            justify-content: center;
            width: 100%;
        }
        .score-block {
            width: 80px;
            height: 80px;
            background-color: #2c3e50;
            color: white;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            font-size: 14px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            user-select: none;
            position: relative;
            z-index: 1;
            padding: 5px;
            text-align: center;
        }
        .score-block .nickname {
            font-size: 12px;
            margin-bottom: 3px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            width: 100%;
        }
        .score-block .score {
            font-size: 20px;
        }
        .score-block.pressed {
            background-color: #34495e;
            transform: scale(0.98);
        }
        .score-block.long-press {
            background-color: #e74c3c;
        }
        .add-btn {
            width: 80px;
            height: 80px;
            background-color: #ecf0f1;
            border: 2px dashed #bdc3c7;
            color: #7f8c8d;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 36px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            user-select: none;
            z-index: 1;
        }
        .add-btn.pressed {
            background-color: #e0e6e8;
            transform: scale(0.98);
        }
        .clear-btn {
            padding: 12px 40px;
            background-color: #2c3e50;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 18px;
            cursor: pointer;
            transition: all 0.2s ease;
            user-select: none;
            z-index: 1;
        }
        .clear-btn.pressed {
            background-color: #34495e;
            transform: scale(0.98);
        }
        /* 自定义弹窗样式 */
        .custom-prompt {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            touch-action: none;
        }
        .prompt-dialog {
            background: white;
            padding: 25px;
            border-radius: 10px;
            width: 85%;
            max-width: 320px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
        }
        .prompt-title {
            font-size: 17px;
            color: #333;
            margin-bottom: 20px;
            text-align: center;
        }
        .prompt-input {
            width: 100%;
            padding: 12px;
            font-size: 18px;
            border: 1px solid #ddd;
            border-radius: 6px;
            margin-bottom: 20px;
            text-align: center;
            outline: none;
            -webkit-appearance: none;
        }
        .prompt-btns {
            display: flex;
            gap: 10px;
            justify-content: center;
        }
        .prompt-btn {
            padding: 10px 25px;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .btn-cancel {
            background-color: #ecf0f1;
            color: #7f8c8d;
        }
        .btn-cancel:active {
            background-color: #d5dbdb;
        }
        .btn-confirm {
            background-color: #2c3e50;
            color: white;
        }
        .btn-confirm:active {
            background-color: #34495e;
        }
    </style>
</head>
<body>
    <div class="main-container">
        <div class="score-container">
            <div class="score-block" data-score="0" data-nickname="玩家1">
                <div class="nickname">玩家1</div>
                <div class="score">0</div>
            </div>
            <div class="score-block" data-score="0" data-nickname="玩家2">
                <div class="nickname">玩家2</div>
                <div class="score">0</div>
            </div>
            <div class="add-btn">+</div>
        </div>
        <button class="clear-btn">清空</button>
    </div>

    <script>
        // 全局变量
        const scoreContainer = document.querySelector('.score-container');
        const addBtn = document.querySelector('.add-btn');
        const clearBtn = document.querySelector('.clear-btn');
        const LONG_PRESS_TIME = 800;
        let pressTimer = null;
        let activeBlock = null; // 当前按压的块
        let isLongPressTriggered = false;

        // 显示昵称输入弹窗
        function showNicknamePrompt() {
            return new Promise((resolve) => {
                // 创建弹窗
                const promptEl = document.createElement('div');
                promptEl.className = 'custom-prompt';
                promptEl.innerHTML = `
                    <div class="prompt-dialog">
                        <div class="prompt-title">请输入玩家昵称</div>
                        <input type="text" class="prompt-input" placeholder="例如：张三" autocomplete="off">
                        <div class="prompt-btns">
                            <button class="prompt-btn btn-cancel">取消</button>
                            <button class="prompt-btn btn-confirm">确认</button>
                        </div>
                    </div>
                `;
                document.body.appendChild(promptEl);

                const input = promptEl.querySelector('.prompt-input');
                const cancelBtn = promptEl.querySelector('.btn-cancel');
                const confirmBtn = promptEl.querySelector('.btn-confirm');

                // 强制聚焦输入框
                setTimeout(() => {
                    input.focus();
                }, 100);

                // 取消按钮
                cancelBtn.addEventListener('click', () => {
                    document.body.removeChild(promptEl);
                    resolve(null);
                });

                // 确认按钮
                confirmBtn.addEventListener('click', () => {
                    const value = input.value.trim();
                    document.body.removeChild(promptEl);
                    resolve(value);
                });

                // 点击外部关闭
                promptEl.addEventListener('click', (e) => {
                    if (e.target === promptEl) {
                        document.body.removeChild(promptEl);
                        resolve(null);
                    }
                });

                // 回车确认
                input.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') {
                        const value = input.value.trim();
                        document.body.removeChild(promptEl);
                        resolve(value);
                    }
                });
            });
        }

        // ========== 核心修复：移动端触摸事件处理 ==========
        // 触摸开始（优先处理）
        function handleTouchStart(e) {
            e.stopPropagation();
            e.preventDefault();
            
            const target = e.target.closest('.score-block');
            if (!target) return;

            activeBlock = target;
            isLongPressTriggered = false;

            // 添加按压样式
            target.classList.add('pressed');

            // 启动长按计时器
            pressTimer = setTimeout(() => {
                isLongPressTriggered = true;
                target.classList.add('long-press');
                handleLongPress(target);
            }, LONG_PRESS_TIME);
        }

        // 触摸结束
        function handleTouchEnd(e) {
            e.stopPropagation();
            e.preventDefault();

            if (!activeBlock) return;

            // 清除计时器和样式
            clearTimeout(pressTimer);
            activeBlock.classList.remove('pressed', 'long-press');

            // 如果不是长按，触发点击事件
            if (!isLongPressTriggered && activeBlock) {
                handleScoreEdit(activeBlock);
            }

            activeBlock = null;
        }

        // 长按处理
        function handleLongPress(block) {
            const blockCount = document.querySelectorAll('.score-block').length;
            if (blockCount <= 2) {
                alert('至少保留2个计分块');
                return;
            }
            if (confirm(`确定删除 ${block.dataset.nickname} 吗？`)) {
                block.remove();
            }
        }

        // ========== 分数编辑（自定义弹窗） ==========
        function showCustomPrompt() {
            return new Promise((resolve) => {
                // 创建弹窗
                const promptEl = document.createElement('div');
                promptEl.className = 'custom-prompt';
                promptEl.innerHTML = `
                    <div class="prompt-dialog">
                        <div class="prompt-title">请输入要添加的分数（增量）</div>
                        <input type="number" class="prompt-input" value="" autocomplete="off">
                        <div class="prompt-btns">
                            <button class="prompt-btn btn-cancel">取消</button>
                            <button class="prompt-btn btn-confirm">确认</button>
                        </div>
                    </div>
                `;
                document.body.appendChild(promptEl);

                const input = promptEl.querySelector('.prompt-input');
                const cancelBtn = promptEl.querySelector('.btn-cancel');
                const confirmBtn = promptEl.querySelector('.btn-confirm');

                // 强制聚焦输入框（移动端关键）
                setTimeout(() => {
                    input.focus();
                    // 移动端唤起键盘
                    if (input.setSelectionRange) {
                        input.setSelectionRange(0, input.value.length);
                    }
                }, 100);

                // 取消按钮
                cancelBtn.addEventListener('click', () => {
                    document.body.removeChild(promptEl);
                    resolve(null);
                });

                // 确认按钮
                confirmBtn.addEventListener('click', () => {
                    const value = input.value.trim();
                    document.body.removeChild(promptEl);
                    resolve(value);
                });

                // 点击外部关闭
                promptEl.addEventListener('click', (e) => {
                    if (e.target === promptEl) {
                        document.body.removeChild(promptEl);
                        resolve(null);
                    }
                });

                // 回车确认
                input.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') {
                        const value = input.value.trim();
                        document.body.removeChild(promptEl);
                        resolve(value);
                    }
                });
            });
        }

        // 编辑分数逻辑
        async function handleScoreEdit(block) {
            try {
                const currentScore = parseInt(block.dataset.score || 0);
                const addScoreStr = await showCustomPrompt();

                if (addScoreStr === null || addScoreStr === '') return;

                const addScore = parseInt(addScoreStr);
                if (isNaN(addScore)) {
                    alert('请输入有效的数字！');
                    return;
                }

                const newScore = currentScore + addScore;
                block.dataset.score = newScore;
                block.querySelector('.score').textContent = newScore;
            } catch (e) {
                console.error('编辑分数出错：', e);
            }
        }

        // ========== 其他功能 ==========
        // 添加计分块
        async function handleAddBlock() {
            const currentBlocks = document.querySelectorAll('.score-block').length;
            if (currentBlocks >= 10) {
                alert('最多支持10人计分');
                return;
            }
            
            // 弹出昵称输入框
            const nickname = await showNicknamePrompt();
            if (!nickname) {
                return; // 如果取消输入或未输入内容，则不添加
            }
            
            const newBlock = document.createElement('div');
            newBlock.className = 'score-block';
            newBlock.dataset.score = '0';
            newBlock.dataset.nickname = nickname;
            newBlock.innerHTML = `
                <div class="nickname">${nickname}</div>
                <div class="score">0</div>
            `;
            
            // 绑定触摸事件
            newBlock.addEventListener('touchstart', handleTouchStart);
            newBlock.addEventListener('touchend', handleTouchEnd);
            newBlock.addEventListener('touchcancel', handleTouchEnd);

            // 绑定PC端事件
            newBlock.addEventListener('click', () => {
                if (!isLongPressTriggered) {
                    handleScoreEdit(newBlock);
                }
            });
            newBlock.addEventListener('mousedown', (e) => {
                e.preventDefault();
                newBlock.classList.add('pressed');
                pressTimer = setTimeout(() => {
                    isLongPressTriggered = true;
                    handleLongPress(newBlock);
                }, LONG_PRESS_TIME);
            });
            newBlock.addEventListener('mouseup', () => {
                clearTimeout(pressTimer);
                newBlock.classList.remove('pressed');
            });
            newBlock.addEventListener('mouseleave', () => {
                clearTimeout(pressTimer);
                newBlock.classList.remove('pressed');
            });

            scoreContainer.insertBefore(newBlock, addBtn);
        }

        // 清空分数
        function handleClearScores() {
            document.querySelectorAll('.score-block').forEach(block => {
                block.dataset.score = '0';
                block.querySelector('.score').textContent = '0';
            });
        }

        // ========== 初始化事件绑定 ==========
        function initEvents() {
            // 计分块触摸事件（移动端核心）
            document.querySelectorAll('.score-block').forEach(block => {
                block.addEventListener('touchstart', handleTouchStart);
                block.addEventListener('touchend', handleTouchEnd);
                block.addEventListener('touchcancel', handleTouchEnd);
            });

            // +号按钮事件
            addBtn.addEventListener('touchstart', (e) => {
                e.preventDefault();
                addBtn.classList.add('pressed');
            });
            addBtn.addEventListener('touchend', (e) => {
                e.preventDefault();
                addBtn.classList.remove('pressed');
                handleAddBlock();
            });

            // 清空按钮事件
            clearBtn.addEventListener('touchstart', (e) => {
                e.preventDefault();
                clearBtn.classList.add('pressed');
            });
            clearBtn.addEventListener('touchend', (e) => {
                e.preventDefault();
                clearBtn.classList.remove('pressed');
                handleClearScores();
            });

            // PC端兼容（备用）
            document.querySelectorAll('.score-block').forEach(block => {
                block.addEventListener('click', () => {
                    if (!isLongPressTriggered) {
                        handleScoreEdit(block);
                    }
                });
                block.addEventListener('mousedown', (e) => {
                    e.preventDefault();
                    block.classList.add('pressed');
                    pressTimer = setTimeout(() => {
                        isLongPressTriggered = true;
                        handleLongPress(block);
                    }, LONG_PRESS_TIME);
                });
                block.addEventListener('mouseup', () => {
                    clearTimeout(pressTimer);
                    block.classList.remove('pressed');
                });
                block.addEventListener('mouseleave', () => {
                    clearTimeout(pressTimer);
                    block.classList.remove('pressed');
                });
            });

            addBtn.addEventListener('click', handleAddBlock);
            clearBtn.addEventListener('click', handleClearScores);
        }

        // 初始化
        window.addEventListener('DOMContentLoaded', () => {
            initEvents();
            // 禁用浏览器默认行为
            document.addEventListener('touchmove', (e) => e.preventDefault(), { passive: false });
        });
    </script>
</body>
</html>